# Auto-publish to GitHub Packages on push to main.
# Reads scope and package name from ds.config.json — no hardcoded org names.
name: Publish to GitHub Packages

on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "scripts/**"
      - "package.json"
      - "ds.config.json"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      # ── Checkout ────────────────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      # ── Read ds.config.json ─────────────────────────────────────────────
      - name: Read config
        id: config
        run: |
          echo "scope=$(node -p "require('./ds.config.json').scope")" >> "$GITHUB_OUTPUT"
          echo "package=$(node -p "require('./ds.config.json').packageName")" >> "$GITHUB_OUTPUT"
          echo "full_name=$(node -p "const c=require('./ds.config.json'); c.scope+'/'+c.packageName")" >> "$GITHUB_OUTPUT"

      # ── Node.js ─────────────────────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"
          scope: ${{ steps.config.outputs.scope }}

      # ── Install & generate ─────────────────────────────────────────────
      - name: Install dependencies
        run: npm ci

      - name: Generate .cursorrules
        run: npm run generate:cursorrules

      # ── Version bump ───────────────────────────────────────────────────
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump version (patch)
        run: |
          npm version patch -m "chore: bump version to %s [skip ci]"
          git push --follow-tags

      # ── Publish ────────────────────────────────────────────────────────
      - name: Configure npm for GitHub Packages
        run: |
          echo "${{ steps.config.outputs.scope }}:registry=https://npm.pkg.github.com" > .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Publish package
        run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ── Release ────────────────────────────────────────────────────────
      - name: Get published version
        id: version
        run: echo "version=$(node -p "require('./package.json').version")" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: Release v${{ steps.version.outputs.version }}
          body: |
            Auto-generated release

            - Updated .cursorrules
            - Component library updates

            Install: `npm install ${{ steps.config.outputs.full_name }}`
          draft: false
          prerelease: false

      # ── Summary ────────────────────────────────────────────────────────
      - name: Job summary
        run: |
          echo "### Published ${{ steps.config.outputs.full_name }}@${{ steps.version.outputs.version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "- Scope: \`${{ steps.config.outputs.scope }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Package: \`${{ steps.config.outputs.package }}\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Version: \`${{ steps.version.outputs.version }}\`" >> "$GITHUB_STEP_SUMMARY"
